!function(){"use strict";function __awaiter(t,e,i,a){return new(i||(i=Promise))(function(s,h){function fulfilled(t){try{step(a.next(t))}catch(t){h(t)}}function rejected(t){try{step(a.throw(t))}catch(t){h(t)}}function step(t){t.done?s(t.value):new i(function(e){e(t.value)}).then(fulfilled,rejected)}step((a=a.apply(t,e||[])).next())})}class t{constructor(){this.preLoad()}static get Instance(){return null==this._instance&&(this._instance=new t),this._instance}preLoad(){Laya.Scene.load(t.DefaultLoadScene,Laya.Handler.create(this,t=>{this._loadingScene=t}))}open(t,e=null,i=!1,a=!0,s=null,h=null){return __awaiter(this,void 0,void 0,function*(){try{if(i&&!this._loadingScene)return void Laya.timer.once(100,this,this.open,[t,a,i,e,s,h]);i&&(Laya.Scene.setLoadingPage(this._loadingScene),Laya.Scene.showLoadingPage(null,0),s=s||Laya.Handler.create(this,this._doProgress,null,!1)),e=e||this._getDefaultPromise();let n=this._doLoadScene(t,s),r=yield Promise.all([n,e]),l=r[0],o=r[1];h&&h.runWith(l),s&&s.recover(),l.open(!0,o),i&&(Laya.Scene.setLoadingPage(this._loadingScene),Laya.Scene.hideLoadingPage(0))}catch(e){console.warn(`加载${t}出现异常:${e}`)}})}_doProgress(t){this._loadingScene.event(Laya.Event.PROGRESS,t)}_doLoadScene(t,e){return new Promise((i,a)=>{Laya.Scene.load(t,Laya.Handler.create(this,t=>{Laya.Scene.setLoadingPage(null),i(t)}),e)})}_getDefaultPromise(){return Promise.resolve()}}t.MinLoadTime=500,t.DefaultLoadScene="bubble/LoadingScene.scene";class e{static getMusicPath(t){return`sound/music_${t}.mp3`}static getAudioPath(t){return`sound/audio_${t}.mp3`}static getObstacleRes(t){return`gameSkin/bubble_${t}.png`}static getEmotionRes(t){return`chat/anim/emoji_${t}.ani`}}e.RES_ATLAS_EMOTION="res/atlas/chat/emoji.atlas",e.RES_SOUND_CLICK="click",e.RES_SOUND_BG="bg",e.RES_SOUND_EAT="eat",e.RES_SOUND_WIN="win",e.RES_SOUND_FAIL="fail",e.RES_SOUND_RETURN="return",e.RES_SCENE_LAUNCH="bubble/LaunchScene.scene",e.RES_SCENE_SELECT="bubble/SelectScene.scene",e.RES_SCENE_Main="bubble/MainScene.scene";class i{static playMusic(t,i=!1){let a=e.getMusicPath(t);i?this._useGesture||(Laya.SoundManager.playMusic(a,0),this._useGesture=!0):Laya.SoundManager.playMusic(a,0)}static playAudio(t){let i=e.getAudioPath(t);Laya.SoundManager.playSound(i,1)}}i._useGesture=!1;class a extends Laya.Script{constructor(){super(),this.scaleRatio=1.1,this.tweenTime=200}onAwake(){this._btnOwner=this.owner,this._btnOwner.anchorX=this._btnOwner.anchorY=.5}onMouseDown(){Laya.Tween.clearAll(this._btnOwner),Laya.Tween.to(this._btnOwner,{scaleX:this.scaleRatio,scaleY:this.scaleRatio},this.tweenTime)}onMouseUp(){Laya.Tween.clearAll(this._btnOwner),Laya.Tween.to(this._btnOwner,{scaleX:1,scaleY:1},this.tweenTime)}onMouseOut(){Laya.Tween.clearAll(this._btnOwner),Laya.Tween.to(this._btnOwner,{scaleX:1,scaleY:1},this.tweenTime)}onClick(){this.clickHandler&&this.clickHandler.run(),i.playAudio(e.RES_SOUND_CLICK)}}class s extends Laya.Script{constructor(){super(),this.isFitStageSize=!0,this.isReCalcScale=!0}static get minScale(){return this._minScale||1}static get maxScale(){return this._maxScale||1}onEnable(){Laya.stage.on(Laya.Event.RESIZE,this,this.onResize),this.onResize()}onDisable(){Laya.stage.off(Laya.Event.RESIZE,this,this.onResize)}onResize(){this.isReCalcScale&&(s._minScale=Math.min(Laya.stage.width/s.DesignWidth,Laya.stage.height/s.DesignHeight),s._maxScale=Math.max(Laya.stage.width/s.DesignWidth,Laya.stage.height/s.DesignHeight),console.log(`当前适配最小缩放/最大缩放:${s.minScale}/${s.maxScale}`)),this.isFitStageSize&&this.owner.size(Laya.stage.width,Laya.stage.height),this.owner.callLater(this._doResize,[this])}_doResize(t){let e=t.owner.getComponents(Laya.Script);for(let i in e){let a=e[i];a!=t&&a.onResize&&a.onResize()}let i=t.owner;i.onResize&&i.onResize()}}s.DesignWidth=720,s.DesignHeight=1280;class h{static MakeRegularBubble(t,e,i,a=512){var s,h,n=a,r=2*Math.PI,l=[],o=2*-Math.PI/3;s=t+i*Math.cos(o),h=e+i*Math.sin(o);for(var b=0;b<n;b++){o+=r/n;let a=t+i*Math.cos(o)-s,b=e+i*Math.sin(o)-h;l.push(a),l.push(b)}return[s,h,l]}static MakeBezierBubble(t,e,i,a=0,s=0,h=512){var n,r,l=h,o=2*Math.PI,b=[],c=2*-Math.PI/3;n=t+i*Math.cos(c),r=e+i*Math.sin(c);let u=Math.floor(2*l/3);for(var p=0;p<u;p++){c+=o/l;let a=0,s=t+(i+a)*Math.cos(c)-n,h=e+(i+a)*Math.sin(c)-r;b.push(s),b.push(h)}let d=b[b.length-2]+n,g=b[b.length-1]+r,m=n,_=r,S=d-2*i+a,y=(g+_)/2+s,L=l-u;for(let t=0;t<L;++t){let e=t/L,i=this.getBezieratX(d,S,m,e)-n,a=this.getBezieratY(g,y,_,e)-r;b.push(i),b.push(a)}return[n,r,b]}static MakeRRBubble(t,e,i,a,s=512){var h,n,r,l,o=s,b=2*Math.PI;n=2*-Math.PI/3;var c=[];r=t+(h=i+Math.random()*(a-i))*Math.cos(n),l=e+h*Math.sin(n);for(var u=0;u<o;u++){n+=b/o;let s=t+(h=i+Math.random()*(a-i))*Math.cos(n)-r,u=e+h*Math.sin(n)-l;c.push(s),c.push(u)}return[r,l,c]}static MakeIrregularBubble(t,e,i,a,s){var h,n,r,l,o,b=2*Math.PI,c=[];for(r=s,l=t+(n=i+(h=this.setLinePoints(9).first).y*(a-i))*Math.cos(r),o=e+n*Math.sin(r);null!=h.next;){r=b*(h=h.next).x+s;let u=t+(n=i+h.y*(a-i))*Math.cos(r)-l,p=e+n*Math.sin(r)-o;c.push(u),c.push(p)}return[l,o,c]}static setLinePoints(t){var e,i,a,s,h,n={first:{x:0,y:1}},r=1,l=1;n.first.next={x:1,y:1};for(var o=0;o<t;o++)for(e=n.first;null!=e.next;){a=(i=e.next).x-e.x,s=.5*(e.x+i.x),h=.5*(e.y+i.y);var b={x:s,y:h+=a*(2*Math.random()-1)};h<r?r=h:h>l&&(l=h),b.next=i,e.next=b,e=i}var c=1/(l-r);for(e=n.first;null!=e;)e.y=c*(e.y-r),e=e.next;return n}static wait(t){return new Promise(e=>{Laya.timer.once(t,this,()=>{e()})})}static getBezieratX(t,e,i,a){let s;return a=Math.min(a,1),s=Math.pow(1-a,2)*t+2*a*(1-a)*e+Math.pow(a,2)*i}static getBezieratY(t,e,i,a){let s;return a=Math.min(a,1),s=Math.pow(1-a,2)*t+2*a*(1-a)*e+Math.pow(a,2)*i}static gradientColors(t,e,i,a){var s,h,n,r,l=[],o=[];a=a||1;var b=function(t){return Math.pow(t/255,a)};for(t=this.parseColor(t).map(b),e=this.parseColor(e).map(b),s=0;s<i;s++){for(r=1-(n=s/(i-1)),h=0;h<3;h++)o[h]=this.pad(Math.round(255*Math.pow(t[h]*r+e[h]*n,1/a)).toString(16));l.push("#"+o.join(""))}return l}static parseColor(t){return 4===t.length?t.substr(1).split("").map(function(t){return 17*parseInt(t,16)}):[t.substr(1,2),t.substr(3,2),t.substr(5,2)].map(function(t){return parseInt(t,16)})}static pad(t){return 1===t.length?"0"+t:t}static powerDistance(t,e,i,a){return Math.pow(i-t,2)+Math.pow(a-e,2)}static clamp(t,e,i){return t<e?e:t>i?i:t}static randomRange(t,e){return t+Math.random()*(e-t)}static hasProbability(t){return 100*Math.random()<t}static unTarget(t,e,i=30){let a=Math.atan2(t.y-e.y,t.x-e.x);return i=Math.random()>=.5?-i*Math.random():i*Math.random(),Laya.Utils.toAngle(a)+i}static fmtTime(t){let e=Math.floor(t/60),i=t%60;return`${e<10?`0${e}`:e}:${i<10?`0${i}`:i}`}}class n extends Laya.Script{constructor(){super()}onAwake(){this.owner.autoDestroyAtClosed=!0,this._group=this.owner.getChildByName("uiGroup"),this._progress=this._group.getChildByName("progress")}onEnable(){this._progress.value=0,t.Instance.open(e.RES_SCENE_SELECT,h.wait(n.MinLoadTime),!1,!0,Laya.Handler.create(this,this.onProgress,null,!1))}onDisable(){}onProgress(t){this._progress.value=t}onClick(t){i.playMusic(e.RES_SOUND_BG,!0)}onResize(){this._group.scale(s.minScale,s.minScale)}}n.MinLoadTime=1e3;class r extends Laya.Script{constructor(){super()}onAwake(){this._progress=this.owner.getChildByName("progress")}onEnable(){this._progress.value=0,this.owner.on(Laya.Event.PROGRESS,this,this.onProgress),Laya.stage.on(Laya.Event.RESIZE,this,this.onResize)}onProgress(t){let e=(new Date).getTime();console.log(e+" 加载进度:"+t),this._progress.value=t}onDisable(){this.owner.off(Laya.Event.PROGRESS,this,this.onProgress),Laya.stage.off(Laya.Event.RESIZE,this,this.onResize)}onResize(){this.owner.scale(s.minScale,s.minScale)}}var l,o,b,c,u=Laya.ClassUtils.regClass;!function(t){!function(t){class e extends Laya.View{constructor(){super()}createChildren(){super.createChildren(),this.createView(e.uiView)}}e.uiView={type:"View",props:{width:720,height:1280},compId:2,child:[{type:"Image",props:{top:20,skin:"gameSkin/img_bg1.png",centerX:-194,sizeGrid:"20,25,20,25"},compId:3,child:[{type:"Label",props:{var:"labelTotalScore",text:"得分:0",fontSize:26,color:"#ffffff",centerY:0,centerX:0},compId:5}]},{type:"Image",props:{top:20,skin:"gameSkin/img_bg1.png",centerX:35,sizeGrid:"20,25,20,25"},compId:4,child:[{type:"Label",props:{y:10,x:-125,var:"labelTime",text:"02:59",fontSize:26,color:"#ffffff",centerY:0,centerX:0},compId:6}]},{type:"Box",props:{y:80,width:196,var:"boxList",right:10,height:280},compId:15,child:[{type:"Image",props:{var:"img_bgRankList",skin:"gameSkin/img_bg2.png",right:0,left:0,height:280,sizeGrid:"10,10,10,10"},compId:7},{type:"List",props:{y:10,var:"rankList",spaceY:5,right:0,repeatY:1,repeatX:1,left:0},compId:8}]},{type:"Image",props:{var:"groupKill",top:20,skin:"gameSkin/img_bgKill.png",centerX:0},compId:16,child:[{type:"Label",props:{y:109,x:217,width:103,var:"labelSrc",text:"XXX",height:28,fontSize:28,color:"#ffffff"},compId:17},{type:"Label",props:{y:167,x:287,width:163,var:"labelDst",text:"XXX",height:28,fontSize:28,color:"#ffffff",align:"right"},compId:18},{type:"Image",props:{y:111,x:273.013671875,skin:"gameSkin/img_txtEat.png"},compId:19}]},{type:"Image",props:{var:"groupMatch",top:0,skin:"loadSkin/img_blank.png",right:0,left:0,bottom:0,sizeGrid:"4,4,4,4"},compId:20,child:[{type:"Image",props:{skin:"gameSkin/img_txtMatch.png",centerY:-50,centerX:0},compId:23},{type:"HBox",props:{var:"matchBox1",space:15,centerY:150,centerX:0,align:"middle"},compId:25},{type:"HBox",props:{x:360,var:"matchBox2",space:15,centerY:270,centerX:0,align:"middle"},compId:30},{type:"ProgressBar",props:{y:1023,width:476,var:"progress",skin:"loadSkin/progress.png",height:35,centerY:400,centerX:0},compId:22},{type:"Label",props:{var:"labelProgress",text:"已匹配",fontSize:28,color:"#ffffff",centerY:447,centerX:0},compId:33}]}],loadList:["gameSkin/img_bg1.png","gameSkin/img_bg2.png","gameSkin/img_bgKill.png","gameSkin/img_txtEat.png","loadSkin/img_blank.png","gameSkin/img_txtMatch.png","loadSkin/progress.png"],loadList3D:[]},t.GameRenderUI=e,u("ui.bubble.GameRenderUI",e);class i extends Laya.View{constructor(){super()}createChildren(){super.createChildren(),this.createView(i.uiView)}}i.uiView={type:"View",props:{width:720,mouseEnabled:!0,height:1280},compId:2,child:[{type:"Image",props:{var:"uiGroup",top:0,skin:"gameSkin/img_blank.png",right:0,left:0,bottom:0,sizeGrid:"4,4,4,4"},compId:16,child:[{type:"Box",props:{y:95,x:110,width:500,height:450,centerY:-320,centerX:0},compId:31,child:[{type:"Image",props:{y:213.5,x:251,var:"img_star",skin:"gameSkin/img_star.png",rotation:0,centerX:0,anchorY:.5,anchorX:.5},compId:17},{type:"Image",props:{y:160.5,x:-109,skin:"gameSkin/img_bgTitle.png",centerX:0},compId:18},{type:"Label",props:{y:180.5,x:-109,var:"labelRank",text:"排名",fontSize:45,color:"#ffffff",centerX:0},compId:28}]},{type:"Box",props:{y:468,x:60,width:600,var:"boxHtmlTxt",height:100,centerY:-122,centerX:0},compId:20,child:[{type:"HTMLDivElement",props:{x:0,width:218,var:"htmlTxt",text:"被XXX吃掉了",height:60,fontSize:32,centerY:-159,runtime:"laya.html.dom.HTMLDivElement"},compId:19}]},{type:"Label",props:{y:642,x:265,var:"labelScore",text:"积分: 123",fontSize:45,color:"#ffffff",centerY:24,centerX:0},compId:21},{type:"Image",props:{y:840,var:"btnGet",skin:"gameSkin/img_btnGet.png",centerY:200,centerX:78,anchorY:.5,anchorX:.5},compId:24,child:[{type:"Script",props:{runtime:"common/ScaleButton.ts"},compId:30}]},{type:"Box",props:{width:84,height:70,centerY:200,centerX:-114},compId:32,child:[{type:"Label",props:{var:"labelEnergy",text:"0",right:0,fontSize:45,color:"#ffffff",centerY:0,align:"right"},compId:22,child:[{type:"Image",props:{y:6,x:-34,skin:"gameSkin/img_energy.png",centerY:0},compId:23}]}]}]}],loadList:["gameSkin/img_blank.png","gameSkin/img_star.png","gameSkin/img_bgTitle.png","gameSkin/img_btnGet.png","gameSkin/img_energy.png"],loadList3D:[]},t.GameResultRenderUI=i,u("ui.bubble.GameResultRenderUI",i);class a extends Laya.View{constructor(){super()}createChildren(){super.createChildren(),this.createView(a.uiView)}}a.uiView={type:"View",props:{width:60,height:60},compId:2,child:[{type:"Image",props:{var:"imgHead",top:0,skin:"gameSkin/img_head.jpg",right:0,left:0,bottom:0},compId:3,child:[{type:"Sprite",props:{y:28,x:28,renderType:"mask"},compId:4,child:[{type:"Circle",props:{radius:26,lineWidth:1,fillColor:"#ff0000"},compId:5}]}]},{type:"Label",props:{var:"labelName",text:"名字",fontSize:18,color:"#ffffff",centerX:0,bottom:-20},compId:6}],loadList:["gameSkin/img_head.jpg"],loadList3D:[]},t.HeadRenderUI=a,u("ui.bubble.HeadRenderUI",a);class s extends Laya.View{constructor(){super()}createChildren(){super.createChildren(),this.createView(s.uiView)}}s.uiView={type:"View",props:{x:0,width:180,height:20},compId:2,child:[{type:"Label",props:{y:0,width:90,var:"labelName",text:"玩家姓名",height:20,fontSize:20,color:"#ffffff",centerX:0,align:"center"},compId:3},{type:"Label",props:{y:0,x:0,width:49,var:"labelScore",text:"10",right:0,height:20,fontSize:20,color:"#ffffff",align:"center"},compId:4},{type:"Sprite",props:{y:0,x:10,width:20,var:"icon",height:20},compId:9}],loadList:[],loadList3D:[]},t.RankItemRenderUI=s,u("ui.bubble.RankItemRenderUI",s)}(t.bubble||(t.bubble={}))}(l||(l={}));class p extends l.bubble.GameRenderUI{constructor(){super()}onAwake(){this.img_bgRankList.alpha=.5,this.rankList.itemRender=l.bubble.RankItemRenderUI,this.rankList.renderHandler=new Laya.Handler(this,this.onItemRender)}onEnable(){this.rankList.array=[],this.boxList.visible=!1,this.groupKill.visible=!1,this.groupMatch.visible=!1}onDisable(){}showMatch(t){return __awaiter(this,void 0,void 0,function*(){this.groupMatch.visible=!0;let e=this.matchBox1.centerY;this.matchBox1.centerY=this.matchBox2.centerY,this.progress.value=0;let i=0;for(let a=-1;a<t.length;++a){if(a<4){let i=new l.bubble.HeadRenderUI;i.labelName.text=-1==a?"我":t[a].name,this.matchBox1.addChild(i),3==a&&Laya.Tween.to(this.matchBox1,{centerY:e},200)}else{let e=new l.bubble.HeadRenderUI;e.labelName.text=t[a].name,this.matchBox2.addChild(e)}this.progress.value+=.1,++i,this.labelProgress.text=`已匹配:${i}/10`,yield h.wait(200)}this.groupMatch.visible=!1})}onItemRender(t,e){let i=t.dataSource;t.icon.graphics.clear(),t.icon.graphics.drawCircle(t.icon.width/2,t.icon.height/2,t.icon.width/2,i.color),t.icon.graphics.fillText(`${e+1}`,t.icon.width/2,3,"14px Arial","#000000","center"),t.labelName.text=i.name,t.labelScore.text=i.eatBeans.toString()}updateRankList(...t){this.rankList.array=t,this.rankList.repeatY=t.length,this.boxList.visible=t.length>0,this.img_bgRankList.height=this.rankList.height+15}showTotalScore(t){this.labelTotalScore.text=`得分:${t}`}showLeftTime(t){this.labelTime.text=h.fmtTime(t)}showKillTip(t,e,i=2e3){this.groupKill.visible=!0,this.labelSrc.text=t,this.labelDst.text=e,Laya.timer.clearAll(this),Laya.timer.once(i,this,this.hideKillTip)}hideKillTip(){this.groupKill.visible=!1}onResize(){this.groupMatch.scale(s.minScale,s.minScale)}}class d extends l.bubble.GameResultRenderUI{constructor(){super()}initUI(){this.htmlTxt.style.fontSize=45,this.htmlTxt.style.wordWrap=!0,this.htmlTxt.style.align=Laya.HTMLStyle.ALIGN_CENTER,this.htmlTxt.style.width=this.boxHtmlTxt.width,this.htmlTxt.style.height=this.boxHtmlTxt.height,this.mouseEnabled=!0}onAwake(){this.initUI()}onEnable(){this.on(Laya.Event.CLICK,this,this.onBtnClick)}onDisable(){this.off(Laya.Event.CLICK,this,this.onBtnClick)}onBtnClick(a){a.target==this.btnGet&&(t.Instance.open(e.RES_SCENE_SELECT),i.playAudio(e.RES_SOUND_RETURN))}show(t,e,i,a){this.visible=!0,this.labelRank.text=`第${t}名`,this.labelScore.text=`积分: ${e}`,this.htmlTxt.innerHTML=a?`<span color='#ffffff'>被</span><span color='#e0c4c4'>${a}</span><span color='#ffffff'>吃掉了</span>`:"",this.labelEnergy.text=`${i}`,this.startAutoRotate()}startAutoRotate(){return __awaiter(this,void 0,void 0,function*(){for(;yield h.wait(100),this.activeInHierarchy;)this.img_star.rotation+=2})}hide(){this.visible=!1}onResize(){this.uiGroup.scale(s.minScale,s.minScale)}}class g{constructor(){this.makeFakeData()}static get Instance(){return null==this._instance&&(this._instance=new g),this._instance}makeFakeData(){this._matchList=[];for(let t=0;t<9;++t)this._matchList.push(new m(`路人${t}号`));this._matchList.sort((t,e)=>Math.random()-.5)}get matchList(){return this._matchList}}class m{constructor(t,e=-1){this.name=t,this.head=e}}class _{constructor(){let t=Laya.LocalStorage.getItem(_.KEY_ENERGY)||"0";this.energy=parseInt(t);let e=Laya.LocalStorage.getItem(_.KEY_FIRSTPLAY)||"0";this._isFirstPlay=1==parseInt(e),Laya.LocalStorage.setItem(_.KEY_FIRSTPLAY,"1")}static get Instance(){return null==this._instance&&(this._instance=new _),this._instance}set energy(t){this._energy=t,Laya.LocalStorage.setItem(_.KEY_ENERGY,t.toString())}get energy(){return this._energy}get isFirstPlay(){return this._isFirstPlay}}_.KEY_ENERGY="energy",_.KEY_FIRSTPLAY="firstPlay";class S extends Laya.Sprite{constructor(){super()}init(t,e,i){this.skinIndex=t,this.obsSize=e,this._beansNum=i}get beansNum(){return this._beansNum}set skinIndex(t){let i=e.getObstacleRes(t);this.loadImage(i),this._skinIndex=t}get skinIndex(){return this._skinIndex}set obsSize(t){this._obsSize=t,this.width=this.height=t,this.pivot(t/2,t/2)}get obsSize(){return this._obsSize}}class y{static Create(t,e=0,i=1){let a=Laya.Pool.getItemByClass(this.POOL_SIGN,S);return a.init(t,e,i),a}static Recycle(t){t.removeSelf(),Laya.Pool.recover(this.POOL_SIGN,t)}}y.POOL_SIGN="POOL_OBSTACLE";class L{constructor(){}init(){this.name="",this.eatBeans=0,this.rank=0,this.color="",this.isAI=!0}}class f extends Laya.Sprite{constructor(){super(),this._moveSpeed=f.InitSpeed,this._state=o.INVALID}init(t,e,i){this._shapeSp=this._shapeSp||new Laya.Sprite,this.addChild(this._shapeSp),this._bubbleData=this._bubbleData||new L,this._bubbleData.init(),this.initStar(e),this._initBubbleSize=t,this._visionRange=Laya.stage.width,this._alarmRange=h.randomRange(f.MinAlaramRange,f.MaxAlarmRange),this.skinIndex=e,this.isAI=i,this.level=0,this.setMoveDelta(0,0),this.State=o.NORMAL}reset(){this.State=o.INVALID,this._bubbleSize=0,this._normalShape=null,this._moveShape=null,this.attacker=null,this.aimTarget=null,this.clearVisions(),this.clearAlarms()}initStar(t){if(this._starShapeSp)return;this._starShapeSp=new Laya.Sprite;let e=[];e.push(0,-130),e.push(33,-33),e.push(130,-30),e.push(55,32),e.push(85,130),e.push(0,73),e.push(-85,130),e.push(-55,32),e.push(-130,-30),e.push(-33,-33),this._starShapeSp.graphics.clear(),this._starShapeSp.size(260,260),this._starShapeSp.pivot(130,140);f.SKIN_LIST.length;this._starShapeSp.graphics.drawPoly(130,130,e,f.SKIN_LIST[2])}showStar(t,e,i){this.addChild(this._starShapeSp),this._starShapeSp.pos(t,e),this._starShapeSp.scale(i/320,i/320)}updateShape(t,e){let i=t/2;if(this._killShape=this._killShape||new M(o.SPIKE,i,i,i),null==this._normalShape)this._normalShape=new M(o.NORMAL,i,i,i),[this._normalShape.startX,this._normalShape.startY,this._normalShape.ptList]=h.MakeRegularBubble(i,i,i);else if(this.State==o.NORMAL){this._normalShape.startX+=e/2,this._normalShape.startY+=e/2,this.draw(this._normalShape);let t=this._normalShape,a=new M(o.NORMAL,i,i,i);[a.startX,a.startY,a.ptList]=h.MakeRegularBubble(i,i,i),this.checkTransformShape(t,a,f.TransformTime,this.getEaseFun(this.State,this.State)),this._normalShape=a,this._moveShape.centerX=this._moveShape.centerY=this._moveShape.radius=i,[this._moveShape.startX,this._moveShape.startY,this._moveShape.ptList]=h.MakeBezierBubble(i,i,i),this._killShape.centerY=this._killShape.centerY=this._killShape.radius=i,[this._killShape.startX,this._killShape.startY,this._killShape.ptList]=h.MakeRRBubble(i,i,i,i+.2*i)}if(null==this._moveShape)this._moveShape=new M(o.MOVE,i,i,i),[this._moveShape.startX,this._moveShape.startY,this._moveShape.ptList]=h.MakeBezierBubble(i,i,i);else if(this.State==o.MOVE){this._moveShape.startX+=e/2,this._moveShape.startY+=e/2,this.draw(this._moveShape);let t=this._moveShape,a=new M(o.MOVE,i,i,i);[a.startX,a.startY,a.ptList]=h.MakeBezierBubble(i,i,i),this.checkTransformShape(t,a,f.TransformTime,this.getEaseFun(this.State,this.State)),this._moveShape=a,this._normalShape.centerX=this._normalShape.centerY=this._normalShape.radius=i,[this._normalShape.startX,this._normalShape.startY,this._normalShape.ptList]=h.MakeRegularBubble(i,i,i),this._killShape.centerY=this._killShape.centerY=this._killShape.radius=i,[this._killShape.startX,this._killShape.startY,this._killShape.ptList]=h.MakeRRBubble(i,i,i,i+.2*i)}this._tmpShape=this._tmpShape||new M(o.TMP,i,i,i)}set bubbleSize(t){if(this.bubbleSize==t)return;let e=t-this.bubbleSize;this._bubbleSize=t,this.size(t,t);let i=t/2;this.pivot(i,i),this._shapeSp.size(t,t),this._shapeSp.pivot(i,i),this._shapeSp.pos(i,i),this.updateShape(t,e)}get bubbleSize(){return this._bubbleSize}get attacker(){return this._attacker}set attacker(t){this._attacker=t}get isAI(){return this._bubbleData.isAI}set isAI(t){this._bubbleData.isAI=t}get rank(){return this._bubbleData.rank}set rank(t){this._bubbleData.rank=t}get visionRange(){return this._visionRange}get alarmRange(){return this._alarmRange}get skinIndex(){return this._skinIndex}set skinIndex(t){this._skinIndex=t,this._bubbleData.color=f.SKIN_LIST[t]}set aimTarget(t){this._aimTarget=t,t&&(this.bubbleRotation=180*Math.atan2(t.y-this.y,t.x-this.x)/Math.PI,this.State==o.NORMAL&&(this.State=o.MOVE))}set unAimTarget(t){this._aimTarget=null,this.bubbleRotation=h.unTarget(this,t),this.State==o.NORMAL&&(this.State=o.MOVE)}get aimTarget(){return this._aimTarget&&this._aimTarget.displayedInStage?this._aimTarget:null}get bubbleData(){return this._bubbleData}set bubbleName(t){this.name=t,this._bubbleData.name=t}get bubbleName(){return this._bubbleData.name}set eatBeans(t){this._bubbleData.eatBeans=t,this.level=Math.floor(t/f.AddLevelByBeans)}get eatBeans(){return this._bubbleData.eatBeans}set level(t){this._level=Math.min(t,this.maxLevel),this.bubbleSize=this._initBubbleSize+2*(f.AddSizeByLevel*this.level+this.circleNums*(f.AddSizeByCircle-f.AddSizeByLevel))}get level(){return this._level}getSizeByCircleNum(t){return this._initBubbleSize+2*(t*f.AddCircleByLevels*f.AddSizeByLevel+t*(f.AddSizeByCircle-f.AddSizeByLevel))}get circleNums(){return Math.floor(this.level/f.AddCircleByLevels)}get maxCircleNum(){return f.SKIN_LIST.length-1}get maxLevel(){return this.maxCircleNum*f.AddCircleByLevels}clearVisions(){this._visionObsList&&(this._visionObsList.length=0),this._visionBubbleList&&(this._visionBubbleList.length=0)}addVisionBubble(t){this._visionBubbleList=this._visionBubbleList||[],this._visionBubbleList.push(t)}addVisionObs(t){this._visionObsList=this._visionObsList||[],this._visionObsList.push(t)}clearAlarms(){this._alarmBubbleList&&(this._alarmBubbleList.length=0)}addAlarmBubble(t){this._alarmBubbleList=this._alarmBubbleList||[],this._alarmBubbleList.push(t)}draw(t){this._shapeSp.graphics.clear();let e=this.circleNums,i=(this._skinIndex+e)%f.SKIN_LIST.length,a=(this._skinIndex+1+e)%f.SKIN_LIST.length;if(this._shapeSp.graphics.drawPoly(t.startX,t.startY,t.ptList,f.SKIN_LIST[i],f.SKIN_LIST[a],3),e>=1)for(let t=e-1;t>=0;--t){let e=this.getSizeByCircleNum(t),i=(this._skinIndex+t)%f.SKIN_LIST.length;this._shapeSp.graphics.drawCircle(this.bubbleSize/2,this.bubbleSize/2,e/2,f.SKIN_LIST[i]),0==t&&this.showStar(this.bubbleSize/2,this.bubbleSize/2,e)}else this.showStar(this._normalShape.centerX,this._normalShape.centerY,2*this._normalShape.radius)}set State(t){if(this.State==t)return;let e=this._state;this._state=t,e==o.INVALID&&t==o.NORMAL?(this._curShape=this._normalShape,this.draw(this._normalShape)):this.checkTransformShape(this.getShape(e),this.getShape(t),f.TransformTime,this.getEaseFun(e,t)),this.onStateChange(e,t)}get State(){return this._state}onStateChange(t,e){e==o.DEAD&&I.Recycle(this)}getEaseFun(t,e){return t==o.NORMAL&&e==o.MOVE?Laya.Ease.backOut:t==o.MOVE&&e==o.NORMAL?Laya.Ease.backOut:Laya.Ease.bounceOut}getShape(t){return t==o.NORMAL?this._normalShape:t==o.MOVE?this._moveShape:t==o.SPIKE?this._killShape:null}get bubbleRotation(){return this._shapeSp.rotation}set bubbleRotation(t){this._shapeSp.rotation=t}checkTransformShape(t,e,i,a,s=!1){null!=t&&null!=e&&(this._isTransforming||this.transformShape(t,e,i,a,s))}transformShape(t,e,i,a,s=!1){return __awaiter(this,void 0,void 0,function*(){if(t.ptList.length!=e.ptList.length)return void console.error("两个形状顶点数量不一致!");if(this._isTransforming)return void console.warn("正在变形中,不能再次变形");this._isTransforming=!0;let s=0,n=t.ptList.length,r=t.startX,l=t.startY,o=e.startX,b=e.startY;for(;this._isTransforming&&(yield h.wait(30),this.activeInHierarchy);){let h=a(s+=30,r,o-r,i),c=a(s,l,b-l,i),u=[];for(let p=0;p<n;p+=2){let n=a(s,t.ptList[p]+r,e.ptList[p]+o-t.ptList[p]-r,i)-h,d=a(s,t.ptList[p+1]+l,e.ptList[p+1]+b-t.ptList[p+1]-l,i)-c;u.push(n),u.push(d)}if(this._tmpShape.startX=h,this._tmpShape.startY=c,this._tmpShape.ptList=u,this.draw(this._tmpShape),s>=i){this._curShape=e,this._isTransforming=!1,this.checkStateShape();break}}})}checkStateShape(){this.State==o.NORMAL?this._curShape!=this._normalShape&&this.transformShape(this._curShape,this._normalShape,f.TransformTime,this.getEaseFun(this._curShape.state,this.State)):this.State==o.MOVE?this._curShape!=this._moveShape&&this.transformShape(this._curShape,this._moveShape,f.TransformTime,this.getEaseFun(this._curShape.state,this.State)):this.State==o.SPIKE&&this._curShape!=this._killShape&&this.transformShape(this._curShape,this._killShape,f.TransformTime,this.getEaseFun(this._curShape.state,this.State))}startMove(t,e){this.State==o.NORMAL&&(this.State=o.MOVE,this.bubbleRotation=180*Math.atan2(e-this.y,t-this.x)/Math.PI)}stopMove(){this.isMoving&&(this.State=o.NORMAL)}get isMoving(){return this.State==o.MOVE}get isAlive(){return this.State!=o.INVALID&&this.State!=o.DEAD}set moveSpeed(t){this._moveSpeed=t}get moveSpeed(){return this._moveSpeed}setMoveDelta(t,e){this._moveDelta=this._moveDelta||new Laya.Point,this._moveDelta.x=t,this._moveDelta.y=e}get moveDelta(){return this._moveDelta}setMoveBoundary(t,e){this._moveBoundary=this._moveBoundary||new Laya.Point,this._moveBoundary.x=t,this._moveBoundary.y=e}get moveBoundary(){return this._moveBoundary}update(){this.isAlive&&(this.isMoving?this.updateMove():this.setMoveDelta(0,0),this.autoRotateStar())}autoRotateStar(){this._starShapeSp.rotation+=.5}onEnable(){this.startAILogic()}updateMove(){this.updateTargetLook();var t=this.bubbleRotation*Math.PI/180,e=Math.cos(t)*this._moveSpeed,i=Math.sin(t)*this._moveSpeed;let a=this.x,s=this.y;this.x=h.clamp(this.x+e,this.bubbleSize/2,this.moveBoundary.x-this.bubbleSize/2),this.y=h.clamp(this.y+i,this.bubbleSize/2,this.moveBoundary.y-this.bubbleSize/2),this.setMoveDelta(this.x-a,this.y-s)}updateTargetLook(){this.aimTarget&&(this.bubbleRotation=180*Math.atan2(this.aimTarget.y-this.y,this.aimTarget.x-this.x)/Math.PI)}get isOnBoundary(){return this.x<=this.width/2||this.x>=this.moveBoundary.x-this.width/2||(this.y<=this.width/2||this.y>=this.moveBoundary.y-this.width/2)}startAILogic(){return __awaiter(this,void 0,void 0,function*(){if(this.isAI)for(;this.isAlive;){let t=0;if(this.isOnBoundary)this.bubbleRotation=Math.floor(360*Math.random()),this.State=o.MOVE,t=200;else{let e=this.hasStrongEnemy(),i=this.hasWeakEnemy(),a=!0;if(e?i?h.hasProbability(60)?(this.unAimTarget=e,t=1e3):(this.aimTarget=i,t=1500):h.hasProbability(80)?(this.unAimTarget=e,t=1e3):a=!1:i&&h.hasProbability(70)?(this.aimTarget=i,t=1500):a=!1,!a)if(this._visionObsList&&this._visionObsList.length>0){if(null==this.aimTarget){let e=Math.floor(Math.random()*this._visionObsList.length);this.aimTarget=this._visionObsList[e],t=500}}else{let e=100*Math.random();e<=50?(this.bubbleRotation=Math.floor(360*Math.random()),this.State=o.MOVE,t=1e3):e<=60?(this.State=o.NORMAL,t=100):(this.State=o.MOVE,t=1e3)}}let e=t+Math.floor(300*Math.random());if(yield h.wait(e),!this.activeInHierarchy)break}})}hasStrongEnemy(t=1){let e=this._alarmBubbleList;if(!e||0==e.length)return null;for(let i=0;i<e.length;++i)if(e[i].level-this.level>=t)return e[i];return null}hasWeakEnemy(t=1){let e=this._alarmBubbleList;if(!e||0==e.length)return null;for(let i=0;i<e.length;++i)if(e[i].level-this.level<=-t)return e[i];return null}playEatAnim(){Laya.Tween.clearAll(this._shapeSp),this._shapeSp.scale(1,1),Laya.Tween.from(this._shapeSp,{scaleX:1.3,scaleY:.7},500,Laya.Ease.bounceOut)}playKillAnim(){console.log("播放击杀动画"),this.State=o.SPIKE,Laya.timer.once(300,this,this.resumeState,[o.NORMAL])}resumeState(t){this.State=t,console.log("击杀动画播放完毕,恢复到待机状态")}eat(t){this.eatBeans+=t.beansNum,this.playEatAnim(),y.Recycle(t)}kill(t){t.attacker=this,t.State=o.DEAD,this.playKillAnim()}}f.EMOTION_IDLIST=[1,10,11,13,15,16,17,18,19,2,21,23,27,4,8,9],f.SKIN_LIST=["#ff0000","#ff7d00","#ffff00","#00ff00","0000ff","00ffff","ff00ff"],f.TransformTime=250,f.AddCircleByLevels=10,f.AddLevelByBeans=1,f.AddSizeByCircle=2,f.AddSizeByLevel=1,f.InitSize=50,f.InitSpeed=6,f.MinAlaramRange=50,f.MaxAlarmRange=100;class I{static Create(t,e,i){let a=Laya.Pool.getItemByClass(this.SIGN_BUBBLE,f);return a.init(t,e,i),a}static Recycle(t){t.removeSelf(),t.reset(),Laya.Pool.recover(this.SIGN_BUBBLE,t)}}I.SIGN_BUBBLE="POOL_BUBBLE";class M{constructor(t,e,i,a){this.state=t,this.centerX=e,this.centerY=i,this.radius=a}}!function(t){t[t.INVALID=0]="INVALID",t[t.TMP=1]="TMP",t[t.NORMAL=2]="NORMAL",t[t.MOVE=3]="MOVE",t[t.SPIKE=4]="SPIKE",t[t.SPIKE2=5]="SPIKE2",t[t.DEAD=6]="DEAD"}(o||(o={})),function(t){t[t.Ordinary=0]="Ordinary",t[t.Aggressive=1]="Aggressive",t[t.Defensive=2]="Defensive",t[t.Max=3]="Max"}(b||(b={}));class w extends Laya.Sprite{constructor(){super()}init(t,e){this.size(t,e),this._boundary=new Laya.Point,this._boundary.x=Math.ceil(this.width/w.GridSize)*w.GridSize,this._boundary.y=Math.ceil(this.height/w.GridSize)*w.GridSize,this.drawBg(),this.initObstacles()}update(){this.checkUpdate(),this.checkScrollMap(this._bubbleHero.moveDelta.x,this._bubbleHero.moveDelta.y),this.checkCollider(),this.checkOutOfStage(),this.checkSpawnObs(.3*w.OBS_NUM)}refreshRank(){this._rankDataList=this._rankDataList||[],this._rankDataList.length=0;for(let t=0;t<this._bubbleAIList.length;++t)this._rankDataList.push(this._bubbleAIList[t].bubbleData);this._bubbleHero&&this._rankDataList.push(this._bubbleHero.bubbleData),this._rankDataList.sort((t,e)=>e.eatBeans-t.eatBeans);for(let t=0;t<this._rankDataList.length;++t){let e=this._rankDataList[t];e.isAI?e.rank=t+1:this._bubbleHero.rank=t+1}this.updateRankHandler&&this.updateRankHandler.runWith(this._rankDataList)}checkSpawnObs(t){if(this._obstacleList.length<t){let t=20*Math.random();for(let e=0;e<t;++e){let t=w.GridSize/2+Math.floor(Math.random()*w.GridSize/2),e=Math.floor(8*Math.random()),i=t+Math.random()*(this._boundary.x-2*t),a=t+Math.random()*(this._boundary.y-2*t),s=y.Create(e,t,1);if(s.pos(i,a),this._obsLayer.addChild(s),this._obstacleList.push(s),this._obstacleList.length>=w.OBS_NUM)break}}}checkOutOfStage(){let t=this._bubbleAIList.length;for(let e=0;e<t;++e){let t=this._bubbleAIList[e];if(this.isInStage(t)){this._bubbleIconMap.get(t).visible=!1}else{let e=this._bubbleIconMap.get(t);t.x+this.x<0?e.x=-this.x+e.width/2:t.x+this.x>Laya.stage.width?e.x=Laya.stage.width-this.x-e.width/2:e.x=t.x,t.y+this.y<0?e.y=-this.y+e.height/2:t.y+this.y>Laya.stage.height?e.y=Laya.stage.height-this.y-e.height/2:e.y=t.y,e.graphics.clear(),e.graphics.drawCircle(e.width/2,e.height/2,e.width/2,t.bubbleData.color),e.graphics.fillText(`${t.rank}`,e.width/2,3,"14px Arial","#000000","center"),e.visible=!0}}}checkUpdate(){this._bubbleHero.update();let t=this._bubbleAIList.length;for(let e=0;e<t;++e){this._bubbleAIList[e].update()}}isOnBorder(t){return t.x<=t.width/2||t.x>=this._boundary.x-t.width/2||(t.y<=t.width/2||t.y>=this._boundary.y-t.width/2)}isInStage(t){return!(t.x+this.x<=-t.width/2||t.x+this.x>=Laya.stage.width+t.width/2)&&!(t.y+this.y<=-t.height/2||t.y+this.y>=Laya.stage.height+t.height/2)}checkScrollMap(t,e){let i=this.x+this._bubbleHero.x,a=this.y+this._bubbleHero.y;t>0&&i>Laya.stage.width/2&&Laya.stage.width+Math.abs(this.x)<this._boundary.x?this.x-=t:t<0&&i<Laya.stage.width/2&&this._bubbleHero.x>Laya.stage.width/2&&(this.x-=t),e>0&&a>Laya.stage.height/2&&Laya.stage.height+Math.abs(this.y)<this._boundary.y?this.y-=e:e<0&&a<Laya.stage.height/2&&this._bubbleHero.y>Laya.stage.height/2&&(this.y-=e)}checkCollider(){let t=this._bubbleAIList.length;for(let e=0;e<t;++e){let t=this._bubbleAIList[e];t.clearVisions(),t.clearAlarms()}this._delBubbleList.length=0;for(let e=0;e<t&&this._bubbleHero.isAlive;++e){let t=this._bubbleAIList[e];if(t.isAlive)if(h.powerDistance(this._bubbleHero.x,this._bubbleHero.y,t.x,t.y)<=Math.pow(this._bubbleHero.bubbleSize/2+t.bubbleSize/2,2)){if(this._bubbleHero.level>t.level)this.handleKill(this._bubbleHero,t),this._delBubbleList.push(t);else if(this._bubbleHero.level<t.level){this.handleKill(t,this._bubbleHero),console.log("游戏结束");break}}else h.powerDistance(this._bubbleHero.x,this._bubbleHero.y,t.x,t.y)<=Math.pow(t.bubbleSize/2+t.alarmRange+this._bubbleHero.bubbleSize/2,2)&&t.addAlarmBubble(this._bubbleHero)}for(let e=0;e<t;++e){let i=this._bubbleAIList[e];for(let a=e+1;a<t&&i.isAlive;++a){let t=this._bubbleAIList[a];t.isAlive&&(h.powerDistance(i.x,i.y,t.x,t.y)<=Math.pow(i.bubbleSize/2+t.bubbleSize/2,2)?i.level>t.level?(this.handleKill(i,t),this._delBubbleList.push(t)):i.level<t.level&&(this.handleKill(t,i),this._delBubbleList.push(i)):h.powerDistance(i.x,i.y,t.x,t.y)<=Math.pow(i.visionRange/2+t.bubbleSize/2,2)&&(i.addVisionBubble(t),t.addVisionBubble(i),h.powerDistance(i.x,i.y,t.x,t.y)<=Math.pow(i.bubbleSize/2+i.alarmRange+t.bubbleSize/2,2)?i.addAlarmBubble(t):h.powerDistance(t.x,t.y,i.x,i.y)<=Math.pow(t.bubbleSize/2+t.alarmRange+i.bubbleSize/2,2)&&t.addAlarmBubble(i)))}}this._bubbleAIList=this._delBubbleList.length>0?this._bubbleAIList.filter((t,e,i)=>-1==this._delBubbleList.indexOf(t)):this._bubbleAIList,this._delObstacleList.length=0;let e=this._obstacleList.length;t=this._bubbleAIList.length;for(let i=0;i<e;++i){let e=this._obstacleList[i];if(e.displayedInStage){this._bubbleHero.isAlive&&h.powerDistance(this._bubbleHero.x,this._bubbleHero.y,e.x,e.y)<=Math.pow(this._bubbleHero.bubbleSize/2+e.obsSize/2+5,2)&&(this.handleEatBeans(this._bubbleHero,e),this._delObstacleList.push(e));for(let i=0;i<t&&e.displayedInStage;++i){let t=this._bubbleAIList[i];h.powerDistance(t.x,t.y,e.x,e.y)<=Math.pow(t.bubbleSize/2+e.obsSize/2+5,2)?(this.handleEatBeans(t,e),this._delObstacleList.push(e)):h.powerDistance(t.x,t.y,e.x,e.y)<=Math.pow(t.visionRange/2+e.obsSize/2,2)&&t.addVisionObs(e)}}}this._obstacleList=this._delObstacleList.length>0?this._obstacleList.filter((t,e,i)=>-1==this._delObstacleList.indexOf(t)):this._obstacleList,(this._delBubbleList.length>0||this._delObstacleList.length>0)&&this.refreshRank()}handleEatBeans(t,e){t.eat(e),this.eatHandler&&this.eatHandler.runWith([t,e])}handleKill(t,e){t.kill(e),this.killHandler&&this.killHandler.runWith([t,e]),this.delBubbleIcon(e)}delBubbleIcon(t){let e=this._bubbleIconMap.get(t);e&&e.set_visible(!1),this._bubbleIconMap.delete(t)}addHero(t){this._bubbleHero=t,t.setMoveBoundary(this._boundary.x,this._boundary.y),this.addChild(t)}addPlayers(t){this._bubbleAIList=[],this._delBubbleList=[],this._bubbleIconMap=new Map;for(let e=0;e<w.AI_NUM;++e){let i=Math.floor(Math.random()*f.SKIN_LIST.length),a=f.InitSize+Math.floor(Math.random()*(this._boundary.x-2*f.InitSize)),s=f.InitSize+Math.floor(Math.random()*(this._boundary.y-2*f.InitSize)),h=Math.floor(360*Math.random()),n=I.Create(f.InitSize,i,!0);n.bubbleName=t[e].name,n.bubbleRotation=h,n.pos(a,s),n.setMoveBoundary(this._boundary.x,this._boundary.y),this._bubbleAIList.push(n),this.addChild(n);let r=new Laya.Sprite;r.size(w.IconSize,w.IconSize),r.pivot(r.width/2,r.height/2),r.graphics.drawCircle(r.width/2,r.height/2,r.width/2,f.SKIN_LIST[i]),r.graphics.fillText(`${e+1}`,r.width/2,3,"14px Arial","#000000","center"),this._bubbleIconMap.set(n,r),r.visible=!1,this.addChild(r)}}recycleObjects(){for(let t=0;t<this._bubbleAIList.length;++t){let e=this._bubbleAIList[t];e.isAlive&&(e.State=o.DEAD)}this._bubbleAIList=null,this._bubbleHero.isAlive&&(this._bubbleHero.State=o.DEAD),this._bubbleHero=null;for(let t=0;t<this._obstacleList.length;++t)y.Recycle(this._obstacleList[t]);this._obstacleList=null}initObstacles(){this._obstacleList=[],this._delObstacleList=[],this._obsLayer=new Laya.Sprite,this._obsLayer.cacheAs="bitmap";for(let t=0;t<w.OBS_NUM;++t){let t=w.GridSize/2+Math.floor(Math.random()*w.GridSize/2),e=Math.floor(8*Math.random()),i=t+Math.random()*(this._boundary.x-2*t),a=t+Math.random()*(this._boundary.y-2*t),s=y.Create(e,t,1);this._obstacleList.push(s),s.pos(i,a),this._obsLayer.addChild(s)}this.addChild(this._obsLayer)}hideObstacles(){this._obsLayer.visible=!1}showObstacles(){this._obsLayer.visible=!0}drawBg(){this.graphics.clear();let t=Math.ceil(this.height/w.GridSize),e=Math.ceil(this.width/w.GridSize);for(let e=0;e<=t;++e){let t=0,i=e*w.GridSize,a=this._boundary.x,s=i;this.graphics.drawLine(t,i,a,s,w.LineColor,1)}for(let t=0;t<=e;++t){let e=t*w.GridSize,i=0,a=e,s=this._boundary.y;this.graphics.drawLine(e,i,a,s,w.LineColor,1)}}onDestroy(){}}w.GridSize=50,w.IconSize=20,w.LineColor="#000000",w.MAP_WIDTH=2048,w.MAP_HEIGHT=2048,w.AI_NUM=9,w.OBS_NUM=100;class v extends Laya.Script{constructor(){super(),this._leftTime=0}onAwake(){this.initMap(),this.initUI(),this.initEffect(),this.owner.autoDestroyAtClosed=!0}onEnable(){Laya.stage.on(Laya.Event.MOUSE_DOWN,this,this.onTouchDown),Laya.stage.on(Laya.Event.MOUSE_UP,this,this.onTouchUp),this.gameState=c.MATCH}onDisable(){Laya.stage.off(Laya.Event.MOUSE_DOWN,this,this.onTouchDown),Laya.stage.off(Laya.Event.MOUSE_UP,this,this.onTouchUp)}onMouseMove(){}onTouchDown(){this.gameState==c.START&&(Laya.stage.on(Laya.Event.MOUSE_MOVE,this,this.onTouchMove),this._lastMousePosX=Laya.stage.mouseX,this._lastMousePosY=Laya.stage.mouseY,this._bubbleHero.startMove(this._map.mouseX,this._map.mouseY))}onTouchMove(){if(this.gameState!=c.START)return;let t=Laya.stage.mouseX,e=Laya.stage.mouseY,i=t-this._lastMousePosX,a=e-this._lastMousePosY;if(Math.pow(i,2)+Math.pow(a,2)<=Math.pow(v.TouchThreshold,2))return;let s=180*Math.atan2(a,i)/Math.PI,h=.1*Math.floor(10*s);this._bubbleHero.bubbleRotation=h,this._lastMousePosX=t,this._lastMousePosY=e}onTouchUp(){this.gameState==c.START&&(Laya.stage.off(Laya.Event.MOUSE_MOVE,this,this.onTouchMove),this._bubbleHero.stopMove())}onUpdate(){this.gameState==c.START&&this._map.update()}onDestroy(){this._map.recycleObjects(),this._map=null,this._gameUI=null,this._gameResultUI=null,this._emotionAnim=null}initMap(){this._map=new w,this._map.init(w.MAP_WIDTH,w.MAP_HEIGHT),this.owner.addChildAt(this._map,0),this._map.eatHandler=Laya.Handler.create(this,this.onEat,null,!1),this._map.killHandler=Laya.Handler.create(this,this.onKill,null,!1),this._map.updateRankHandler=Laya.Handler.create(this,this.onRefreshRankList,null,!1),this._map.hideObstacles()}initUI(){this._gameUI=this.owner.getChildByName("gameUI"),this._gameUI.showTotalScore(0),this._gameUI.showLeftTime(0),this._gameResultUI=this.owner.getChildByName("gameResultUI"),this._gameResultUI.hide()}initEffect(){this._emotionAnim=new Laya.Animation,this.owner.addChild(this._emotionAnim)}onKill(t,e){console.log(`玩家【${t.name}】击杀了玩家【${e.name}】`),e==this._bubbleHero?this.gameState=c.END:t==this._bubbleHero?this.playEmotionAnim():this._gameUI.showKillTip(t.name,e.name)}onRefreshRankList(...t){this._gameUI.updateRankList(...t)}onEat(t,a){t==this._bubbleHero&&(this._gameUI.showTotalScore(this._bubbleHero.eatBeans),i.playAudio(e.RES_SOUND_EAT))}startMatch(){return __awaiter(this,void 0,void 0,function*(){yield this._gameUI.showMatch(g.Instance.matchList),this.gameState=c.START})}startCountDown(){return __awaiter(this,void 0,void 0,function*(){for(this.leftTime=v.TotalTime;this.leftTime>0&&this.gameState==c.START&&(yield h.wait(1e3),this.enabled);)this.leftTime-=1;this.gameState=c.END})}showGameResult(){_.Instance.energy+=10*this._bubbleHero.eatBeans;let t=this._bubbleHero.attacker?this._bubbleHero.attacker.bubbleName:null;this._gameResultUI.show(this._bubbleHero.rank,this._bubbleHero.eatBeans,10*this._bubbleHero.eatBeans,t),i.playAudio(t?e.RES_SOUND_FAIL:e.RES_SOUND_WIN)}set leftTime(t){this._leftTime=Math.max(t,0),this._gameUI.labelTime.text=h.fmtTime(this._leftTime)}get leftTime(){return this._leftTime}set gameState(t){if(this._gameState==t)return;let e=this._gameState;this._gameState=t,this.onGameStateChange(e,t)}get gameState(){return this._gameState}onGameStateChange(t,e){e==c.MATCH?this.startMatch():e==c.START?(this._bubbleHero=I.Create(f.InitSize,0,!1),this._bubbleHero.bubbleName="我",this._bubbleHero.pos(Laya.stage.width/2,Laya.stage.height/2),this._map.addHero(this._bubbleHero),this._map.addPlayers(g.Instance.matchList),this._map.showObstacles(),this.startCountDown()):e==c.END&&this.showGameResult()}playEmotionAnim(){if(100*Math.random()>30)return;console.log("播放表情动画");let t=[1,10,11,13,15,16,17,18,19,2,21,23,27,4,8,9],i=Math.floor(Math.random()*t.length);this._emotionAnim.loadAnimation(e.getEmotionRes(t[i]),Laya.Handler.create(this,this.onLoadAnimComplete),e.RES_ATLAS_EMOTION)}onLoadAnimComplete(){let t=this._emotionAnim.getGraphicBounds();this._emotionAnim.visible=!0,this._emotionAnim.pivot(t.x+t.width/2,t.y+t.height/2),this._emotionAnim.pos(Laya.stage.width/2,100),this._emotionAnim.autoPlay=!0,Laya.timer.once(1500,this,this.stopEmotionAnim)}stopEmotionAnim(){this._emotionAnim.clear(),this._emotionAnim.visible=!1}}v.TouchThreshold=10,v.TotalTime=60,function(t){t[t.MATCH=0]="MATCH",t[t.START=1]="START",t[t.END=2]="END"}(c||(c={}));class x extends Laya.Script{constructor(){super()}onAwake(){this._ownerScene=this.owner,this._ownerScene.autoDestroyAtClosed=!0,this.drawBg()}onEnable(){this.labelEnergy.text=_.Instance.energy.toString()}onDisable(){}onResize(){this.drawBg(),this.uiGroup.scale(s.minScale,s.minScale)}onClick(a){i.playMusic(e.RES_SOUND_BG,!0),a.target==this.btnStart&&t.Instance.open(e.RES_SCENE_Main)}drawBg(){this._ownerScene.graphics.clear();let t=Math.ceil(Laya.stage.height/x.GridSize),e=Math.ceil(Laya.stage.width/x.GridSize);for(let e=0;e<=t;++e){let t=0,i=e*x.GridSize,a=Laya.stage.width,s=i;this._ownerScene.graphics.drawLine(t,i,a,s,"#000000",1)}for(let t=0;t<=e;++t){let e=t*x.GridSize,i=0,a=e,s=Laya.stage.height;this._ownerScene.graphics.drawLine(e,i,a,s,"#000000",1)}}}x.GridSize=50;class R{constructor(){}static init(){var t=Laya.ClassUtils.regClass;t("common/ScaleButton.ts",a),t("common/Resize.ts",s),t("control/LaunchControl.ts",n),t("view/LoadingUI.ts",r),t("view/GameUI.ts",p),t("view/GameResultUI.ts",d),t("control/GameControl.ts",v),t("control/SelectControl.ts",x)}}R.width=720,R.height=1280,R.scaleMode="fixedwidth",R.screenMode="vertical",R.alignV="top",R.alignH="left",R.startScene="bubble/LaunchScene.scene",R.sceneRoot="",R.debug=!1,R.stat=!1,R.physicsDebug=!1,R.exportSceneToJson=!0,R.init();new class{constructor(){window.Laya3D?Laya3D.init(R.width,R.height):Laya.init(R.width,R.height,Laya.WebGL),Laya.Physics&&Laya.Physics.enable(),Laya.DebugPanel&&Laya.DebugPanel.enable(),Laya.stage.scaleMode=R.scaleMode,Laya.stage.screenMode=R.screenMode,Laya.stage.alignV=R.alignV,Laya.stage.alignH=R.alignH,Laya.stage.bgColor="#eeeeee",Laya.stage.frameRate=Laya.Stage.FRAME_SLOW,Laya.URL.exportSceneToJson=R.exportSceneToJson,(R.debug||"true"==Laya.Utils.getQueryString("debug"))&&Laya.enableDebugPanel(),R.physicsDebug&&Laya.PhysicsDebugDraw&&Laya.PhysicsDebugDraw.enable(),R.stat&&Laya.Stat.show(),Laya.alertGlobalError(!0),Laya.SoundManager.autoStopMusic=!0,Laya.ResourceVersion.enable("version.json",Laya.Handler.create(this,this.onVersionLoaded),Laya.ResourceVersion.FILENAME_VERSION)}onVersionLoaded(){Laya.AtlasInfoManager.enable("fileconfig.json",Laya.Handler.create(this,this.onConfigLoaded))}onConfigLoaded(){t.Instance.open(R.startScene)}}}();